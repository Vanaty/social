<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Chat</title>
<style>
    body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 300px; border-right: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; background-color: #f7f7f7; }
    #sidebar h2 { margin-top: 0; }
    #sidebar #disconnect-form { margin-top: auto; }
    #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
    #messages { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #ccc; }
    #message-form { display: flex; padding: 10px; align-items: center; }
    #text { flex-grow: 1; margin-right: 10px; }
    .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
    .message.sent { background-color: #dcf8c6; align-self: flex-end; text-align: right; }
    .message.received { background-color: #fff; border: 1px solid #eee; align-self: flex-start; }
    .message-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 4px; color: #555; }
    #messages-display { display: flex; flex-direction: column; }
    .chat-item { padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; border-radius: 5px; }
    .chat-item:hover { background-color: #e9e9e9; }
    .chat-item.active { background-color: #007bff; color: white; }
    .chat-name { font-weight: bold; }
    .chat-participants { font-size: 0.8em; color: #666; }
    .new-chat-section { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    #current-chat-info { padding: 10px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; font-weight: bold; }
    #attach-file-btn {
        padding: 5px 10px;
        margin-right: 10px;
        cursor: pointer;
    }
    .message img {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
    }
</style>
</head>
<body>
<div id="sidebar">
    Welcome <h2 id="username"></h2>
    
    <div class="new-chat-section">
        <button onclick="goToCreateChat()" style="margin-top: 5px; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Create New Chat</button>
    </div>
    
    <h3>Your Chats:</h3>
    <div id="chats-list"></div>
    
    <hr>
    <h3>Online Users:</h3>
    <div id="online_users"></div>
    
    <form id="disconnect-form" method="get" action="/disconnect">
        <button type="submit" id="disconn">Disconnect</button>
    </form>
</div>

<div id="chat-container">
    <div id="current-chat-info">Select a chat to start messaging</div>
    <div id="messages">
        <div id="messages-display"></div>
    </div>
    <div id="message-form">
        <button id="attach-file-btn" disabled>ðŸ“Ž</button>
        <input type="file" id="file-input" style="display: none;" />
        <textarea id="text" rows="3" disabled placeholder="Select a chat to start messaging..."></textarea>
        <button id="send" disabled>Send</button>
    </div>
</div>

</body>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script type="text/javascript">
'use strict';

class ChatApplication {
    constructor() {
        this.token = localStorage.getItem('jwt');
        this.username = localStorage.getItem('username');
        this.userId = localStorage.getItem('userId');
        this.currentChatId = null;
        this.userChats = [];
        this.allUsers = [];
        this.socket = null;
        this.stompClient = null;
        this.webrtcConfig = null;
        this.webrtcConnection = null;
        
        this.init();
    }

    init() {
        if (!this.token || !this.username) {
            window.location.href = '/';
            return;
        }
        
        document.getElementById('username').textContent = this.username;
        this.bindEvents();
        this.connectWebSocket();
        this.initWebRTC();
    }

    async initWebRTC() {
        try {
            const response = await this.fetchWithAuth('/api/webrtc/config');
            this.webrtcConfig = response;
            console.log('WebRTC configuration loaded:', this.webrtcConfig);
        } catch (error) {
            console.error('Failed to load WebRTC configuration:', error);
        }
    }

    bindEvents() {
        const sendButton = document.getElementById('send');
        const textArea = document.getElementById('text');
        const attachButton = document.getElementById('attach-file-btn');
        const fileInput = document.getElementById('file-input');
        
        sendButton?.addEventListener('click', () => this.sendMessage());
        textArea?.addEventListener('keypress', (e) => {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        attachButton?.addEventListener('click', () => fileInput.click());
        fileInput?.addEventListener('change', (e) => this.handleFileUpload(e));
        
        // Add video call button functionality
        this.addVideoCallButton();
    }

    addVideoCallButton() {
        const messageForm = document.getElementById('message-form');
        const videoCallButton = document.createElement('button');
        videoCallButton.id = 'video-call-btn';
        videoCallButton.innerHTML = 'ðŸ“¹';
        videoCallButton.title = 'Start Video Call';
        videoCallButton.disabled = true;
        videoCallButton.style.marginRight = '10px';
        
        videoCallButton.addEventListener('click', () => this.initiateVideoCall());
        
        const attachButton = document.getElementById('attach-file-btn');
        messageForm.insertBefore(videoCallButton, attachButton);
    }

    async initiateVideoCall() {
        if (!this.currentChatId || !this.webrtcConfig) {
            alert('Cannot start video call: No chat selected or WebRTC not configured');
            return;
        }

        try {
            console.log('Initiating video call with WebRTC config:', this.webrtcConfig);
            // Here you would implement the actual WebRTC connection logic
            // For now, just show the available ICE servers
            const iceServers = this.webrtcConfig.iceServers.map(server => ({
                urls: server.urls,
                username: server.username,
                credential: server.credential
            }));
            
            console.log('Available ICE servers:', iceServers);
            alert('Video call feature ready! Check console for ICE servers configuration.');
            
        } catch (error) {
            console.error('Error initiating video call:', error);
            alert('Failed to start video call');
        }
    }

    connectWebSocket() {
        try {
            this.socket = new SockJS("/ws");
            this.stompClient = Stomp.over(this.socket);
            
            const headers = { 'Authorization': `Bearer ${this.token}` };
            
            this.stompClient.connect(headers, 
                async () => await this.onConnect(), 
                (error) => this.onError(error)
            );
        } catch (error) {
            console.error('WebSocket connection failed:', error);
        }
    }

    async onConnect() {
        console.log('WebSocket connected successfully');
        await this.fetchUserChats();
        for (const chat of this.userChats) {
            this.stompClient.subscribe("/topic/chat/" + chat.id, 
                (payload) => this.onMessageReceived(payload)
            );
        }
        
        // this.stompClient.send("/app/chat.subscribe", {}, '1');
        
        // Initialize data
        Promise.all([
            this.fetchUsers(),
            this.fetchOnlineUsers()
        ]).catch(error => console.error('Initialization error:', error));
        
        // Setup periodic updates
        setInterval(() => this.fetchOnlineUsers(), 15000);
    }

    onError(error) {
        console.error('WebSocket error:', error);
        
        if (error.headers?.message?.includes("Access is denied")) {
            localStorage.clear();
            window.location.href = '/';
        }
    }

    async fetchUsers() {
        try {
            const response = await this.fetchWithAuth('/api/users');
            this.allUsers = response;
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    }

    async fetchUserChats() {
        try {
            const chats = await this.fetchWithAuth('/api/chats');
            this.userChats = chats.content;
            this.displayChats(this.userChats);
        } catch (error) {
            console.error('Error fetching chats:', error);
        }
    }

    async fetchOnlineUsers() {
        try {
            const onlineUsers = await this.fetchWithAuth('/api/users/online');
            this.displayOnlineUsers(onlineUsers);
        } catch (error) {
            console.error('Error fetching online users:', error);
        }
    }

    async fetchWithAuth(url) {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${this.token}` }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    }

    displayChats(chats) {
        const chatsList = document.getElementById('chats-list');
        if (!chatsList) return;
        
        chatsList.innerHTML = '';
        
        chats.forEach(chat => {
            const participants = chat.participants
                ?.map(p => p.user?.username)
                ?.filter(u => u !== this.username) || [];
            
            const chatName = chat.isGroupChat ? chat.chatName : participants.join(', ');
            const participantsText = chat.isGroupChat 
                ? `${chat.participants?.length || 0} members` 
                : 'Private chat';
            
            const chatElement = this.createChatElement(chat.id, chatName, participantsText);
            chatsList.appendChild(chatElement);
        });
    }

    createChatElement(chatId, chatName, participantsText) {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.dataset.chatId = chatId;
        div.innerHTML = `
            <div class="chat-name">${this.escapeHtml(chatName)}</div>
            <div class="chat-participants">${this.escapeHtml(participantsText)}</div>
        `;
        
        div.addEventListener('click', () => this.selectChat(chatId, chatName));
        return div;
    }

    selectChat(chatId, chatName) {
        this.currentChatId = chatId;
        
        // Update UI
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const selectedChat = document.querySelector(`[data-chat-id="${chatId}"]`);
        selectedChat?.classList.add('active');
        
        document.getElementById('current-chat-info').textContent = `Chat: ${chatName}`;
        
        const textArea = document.getElementById('text');
        const sendButton = document.getElementById('send');
        
        textArea.disabled = false;
        textArea.placeholder = 'Type your message...';
        sendButton.disabled = false;
        document.getElementById('attach-file-btn').disabled = false;
        
        this.fetchChatMessages(chatId);
    }

    async fetchChatMessages(chatId) {
        try {
            const messagesDisplay = document.getElementById('messages-display');
            if (messagesDisplay) messagesDisplay.innerHTML = '';
            
            let messages = await this.fetchWithAuth(`/api/chats/${chatId}/messages`);
            messages = messages.content || messages;
            messages.forEach(msg => this.displayMessage(msg));
        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }

    displayMessage(msg) {
        const messagesDisplay = document.getElementById('messages-display');
        if (!messagesDisplay) return;
        
        const messageClass = msg.sender?.username === this.username ? 'sent' : 'received';
        const senderName = msg.sender?.username === this.username ? 'You' : msg.sender?.username;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageClass}`;
        
        let contentHtml = `<div class="message-sender">${this.escapeHtml(senderName)}</div>`;
        
        switch(msg.type) {
            case 'IMAGE':
                contentHtml += `<div>${this.escapeHtml(msg.contentText)}</div><img src="${msg.media.fileUrl}" alt="Image">`;
                break;
            case 'FILE':
                contentHtml += `<div><a href="${msg.media.fileUrl}" target="_blank" download>${this.escapeHtml(msg.contentText)}</a></div>`;
                break;
            case 'TEXT':
            default:
                contentHtml += `<div>${this.escapeHtml(msg.contentText)}</div>`;
                break;
        }

        messageDiv.innerHTML = contentHtml;
        
        messagesDisplay.appendChild(messageDiv);
        this.scrollToBottom();
    }

    onMessageReceived(payload) {
        try {
            const msg = JSON.parse(payload.body);

            if (this.currentChatId && msg.chat.id == this.currentChatId) {
                this.displayMessage(msg);
            }
            // Refresh chat list
            this.fetchUserChats();
        } catch (error) {
            console.error('Error processing received message:', error);
        }
    }

    sendMessage() {
        if (!this.currentChatId) {
            alert("Please select a chat first.");
            return;
        }
        
        const textArea = document.getElementById('text');
        const content = textArea.value.trim();
        
        if (!content) return;
        
        const message = {
            sender: this.userId,
            receiver: this.currentChatId,
            content: content,
            messageType: 'TEXT'
        };
        
        try {
            this.stompClient.send("/app/chat.message", {}, JSON.stringify(message));
            textArea.value = '';
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        }
    }

    async handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/files/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${this.token}` },
                body: formData
            });

            if (!response.ok) {
                throw new Error('File upload failed');
            }

            const fileUrl = await response.text();
            
            const messageType = file.type.startsWith('image/') ? 'IMAGE' : 'FILE';

            const message = {
                sender: this.userId,
                receiver: this.currentChatId,
                content: file.name, // Original filename
                fileUrl: fileUrl,
                messageType: messageType
            };

            this.stompClient.send("/app/chat.file", {}, JSON.stringify(message));

        } catch (error) {
            console.error('Error uploading file:', error);
            alert('Failed to upload file.');
        } finally {
            // Reset file input
            event.target.value = '';
        }
    }

    displayOnlineUsers(onlineUsers) {
        const onlineUsersDiv = document.getElementById('online_users');
        if (!onlineUsersDiv) return;
        
        onlineUsersDiv.innerHTML = '';
        onlineUsers.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.textContent = user;
            onlineUsersDiv.appendChild(userDiv);
        });
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

function goToCreateChat() {
    window.location.href = '/create-chat';
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ChatApplication();
});
</script>
</body>
</html>