<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Chat</title>
<style>
    body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; }
    #sidebar { width: 300px; border-right: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; background-color: #f7f7f7; }
    #sidebar h2 { margin-top: 0; }
    #sidebar #disconnect-form { margin-top: auto; }
    #chat-container { flex-grow: 1; display: flex; flex-direction: column; }
    #messages { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #ccc; }
    #message-form { display: flex; padding: 10px; }
    #text { flex-grow: 1; margin-right: 10px; }
    .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 70%; }
    .message.sent { background-color: #dcf8c6; align-self: flex-end; text-align: right; }
    .message.received { background-color: #fff; border: 1px solid #eee; align-self: flex-start; }
    .message-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 4px; color: #555; }
    #messages-display { display: flex; flex-direction: column; }
    .chat-item { padding: 10px; border: 1px solid #ddd; margin-bottom: 5px; cursor: pointer; border-radius: 5px; }
    .chat-item:hover { background-color: #e9e9e9; }
    .chat-item.active { background-color: #007bff; color: white; }
    .chat-name { font-weight: bold; }
    .chat-participants { font-size: 0.8em; color: #666; }
    .new-chat-section { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    #current-chat-info { padding: 10px; background-color: #f0f0f0; border-bottom: 1px solid #ccc; font-weight: bold; }
</style>
</head>
<body>
<div id="sidebar">
    Welcome <h2 id="username"></h2>
    
    <div class="new-chat-section">
        <label for="user-select">Start new chat with:</label>
        <select id="user-select"></select>
        <button onclick="createPrivateChat()" style="margin-top: 5px; padding: 5px 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Start Chat</button>
    </div>
    
    <h3>Your Chats:</h3>
    <div id="chats-list"></div>
    
    <hr>
    <h3>Online Users:</h3>
    <div id="online_users"></div>
    
    <form id="disconnect-form" method="get" action="/disconnect">
        <button type="submit" id="disconn">Disconnect</button>
    </form>
</div>

<div id="chat-container">
    <div id="current-chat-info">Select a chat to start messaging</div>
    <div id="messages">
        <div id="messages-display"></div>
    </div>
    <div id="message-form">
        <textarea id="text" rows="3" disabled placeholder="Select a chat to start messaging..."></textarea>
        <button id="send" disabled>Send</button>
    </div>
</div>

</body>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script type="text/javascript">
const token = localStorage.getItem('jwt');
const username = localStorage.getItem('username');
const userId = localStorage.getItem('userId');
let currentChatId = null;
let userChats = [];
let allUsers = [];

if (!token || !username) {
    window.location.href = '/';
}

document.getElementById('username').textContent = username;

var mysockjs = new SockJS("/stomp");
var mystomp = Stomp.over(mysockjs);

const headers = {
    'Authorization': 'Bearer ' + token
};

mystomp.connect(headers, onConnect, onError);

function onConnect(){
    mystomp.subscribe("/topic/"+'1'+"/reply", onMessageReceived);
    console.log(username+" is username --------")
    mystomp.send("/app/chat.subscribe",{}, '1');
    fetchUsers();
    fetchUserChats();
    fetchOnlineUsers();
    setInterval(fetchOnlineUsers, 10000);
}

function displayMessage(msg) {
    const messagesDisplay = $("#messages-display");
    const messageClass = msg.sender.username === username ? 'sent' : 'received';
    const senderName = msg.sender.username === username ? 'You' : msg.sender.username;
    const markup = `<div class="message ${messageClass}">
                        <div class="message-sender">${senderName}</div>
                        <div>${msg.contentText}</div>
                    </div>`;
    messagesDisplay.append(markup);
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
}

function displayInstantMessage(msg) {
    const messagesDisplay = $("#messages-display");
    const messageClass = msg.sender == userId ? 'sent' : 'received';
    const senderName = msg.sender == userId ? 'You' : msg.sender;
    const markup = `<div class="message ${messageClass}">
                        <div class="message-sender">${senderName}</div>
                        <div>${msg.content}</div>
                    </div>`;
    messagesDisplay.append(markup);
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
}

function onMessageReceived(payload){
    const msg = JSON.parse(payload.body);
    // Display message only if it's part of the current chat
    if (currentChatId && msg.receiver == currentChatId) {
        displayInstantMessage(msg);
    }
    // Refresh chat list to show updated last message
    fetchUserChats();
}

function onError(error){
    console.log("error", error);
    if (error.headers && error.headers.message && error.headers.message.includes("Access is denied")) {
        localStorage.removeItem('jwt');
        localStorage.removeItem('username');
        window.location.href = '/';
    }
}

$("#send").on("click", function(){
    if (!currentChatId) {
        alert("Please select a chat first.");
        return;
    }
    const content = $("#text").val();
    if (content.trim() === '') return;

    const message = {sender:userId, receiver:currentChatId, content: content};
    mystomp.send("/app/chat.message",{}, JSON.stringify(message));
    $("#text").val('');
});

function fetchUsers() {
    fetch('/api/users', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch users');
        return response.json();
    })
    .then(users => {
        allUsers = users;
        const select = $('#user-select');
        select.empty();
        select.append($('<option>', { value: '', text: 'Select a user', disabled: true, selected: true }));
        users.forEach(u => {
            if (u !== username) {
                select.append($('<option>', {
                    value: u,
                    text: u
                }));
            }
        });
    })
    .catch(error => console.error('Error fetching users:', error));
}

function fetchUserChats() {
    fetch('/api/chats', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch chats');
        return response.json();
    })
    .then(chats => {
        userChats = chats;
        displayChats(chats);
    })
    .catch(error => console.error('Error fetching chats:', error));
}

function displayChats(chats) {
    const chatsList = $('#chats-list');
    chatsList.empty();
    
    chats.forEach(chat => {
        const participants = chat.participants.map(p => p.user.username).filter(u => u !== username);
        const chatName = chat.isGroupChat ? chat.chatName : participants.join(', ');
        const participantsText = chat.isGroupChat ? `${chat.participants.length} members` : 'Private chat';
        
        const chatItem = $(`
            <div class="chat-item" data-chat-id="${chat.id}">
                <div class="chat-name">${chatName}</div>
                <div class="chat-participants">${participantsText}</div>
            </div>
        `);
        
        chatItem.on('click', () => selectChat(chat.id, chatName));
        chatsList.append(chatItem);
    });
}

function selectChat(chatId, chatName) {
    currentChatId = chatId;
    $('.chat-item').removeClass('active');
    $(`.chat-item[data-chat-id="${chatId}"]`).addClass('active');
    
    $('#current-chat-info').text(`Chat: ${chatName}`);
    $('#text').prop('disabled', false).attr('placeholder', 'Type your message...');
    $('#send').prop('disabled', false);
    
    fetchChatMessages(chatId);
}

function fetchChatMessages(chatId) {
    $("#messages-display").empty();
    fetch(`/api/chats/${chatId}/messages`, {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch messages');
        return response.json();
    })
    .then(messages => {
        messages.forEach(msg => displayMessage(msg));
    })
    .catch(error => console.error('Error fetching messages:', error));
}

function createPrivateChat() {
    const selectedUser = $('#user-select').val();
    if (!selectedUser) {
        alert('Please select a user to chat with.');
        return;
    }
    
    // Find user ID (assuming we need to fetch user details)
    // For now, we'll use username as placeholder - you may need to modify based on actual API
    const chatData = {
        chatType: 'PRIVATE',
        participants: [selectedUser] // Adjust based on API requirements
    };
    
    fetch('/api/chats/private', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(chatData)
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to create chat');
        return response.json();
    })
    .then(chat => {
        fetchUserChats(); // Refresh chat list
        selectChat(chat.id, chat.isGroupChat ? chat.chatName : selectedUser);
        $('#user-select').val('');
    })
    .catch(error => {
        console.error('Error creating chat:', error);
        alert('Failed to create chat. Maybe you already have a chat with this user?');
    });
}

function fetchOnlineUsers() {
    fetch('/api/users/online', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch online users');
        return response.json();
    })
    .then(onlineUsers => {
        const onlineUsersDiv = $('#online_users');
        onlineUsersDiv.empty();
        onlineUsers.forEach(u => {
            onlineUsersDiv.append(`<div>${u}</div>`);
        });
    })
    .catch(error => console.error('Error fetching online users:', error));
}

// Enable sending message with Enter key
$('#text').on('keypress', function(e) {
    if (e.which === 13 && !e.shiftKey) {
        e.preventDefault();
        $('#send').click();
    }
});
</script>
</body>
</html>